---
- name: plugins | add the plugin to local_requirements.txt
  ansible.builtin.lineinfile:
    path: "{{ netbox_current_path }}/local_requirements.txt"
    line: "{{ item.pip }}"
    regexp: "^{{ item.pip }}"
    owner: "{{ netbox_user }}"
    mode: '0644'
    create: yes
  loop: "{{ netbox_plugins }}"
  loop_control:
    label: "{{ item.pip | default('') }}"
  when: item.pip is defined

- name: plugins | install pip packages
  ansible.builtin.pip:
    requirements: "{{ netbox_current_path }}/local_requirements.txt"
    virtualenv: "{{ netbox_current_path }}/venv"
    virtualenv_command: python3 -m venv
  become: yes
  become_user: "{{ netbox_user }}"
  notify: netbox_plugin_handlers
  # loop: "{{ netbox_plugins }}"
  # loop_control: 
  #   label: "{{ item.pip | default('') }}"
  # when: item.pip is defined


# - name: plugins | install pip packages
#   ansible.builtin.pip:
#     name: "{{ item.pip }}"
#     virtualenv: "{{ netbox_current_path }}/venv"
#     virtualenv_command: python3 -m venv
#   become: yes
#   become_user: "{{ netbox_user }}"
#   notify: netbox_plugin_handlers
#   loop: "{{ netbox_plugins }}"
#   loop_control: 
#     label: "{{ item.pip | default('') }}"
#   when: item.pip is defined
